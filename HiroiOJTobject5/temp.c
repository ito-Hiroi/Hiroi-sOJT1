//*****************************************************************************
/// @file
//*****************************************************************************

//=============================================================================
// includeファイル
//=============================================================================
#include "temp.h"
#include "iodefine.h"
//=============================================================================
// マクロ定義(定数, 関数マクロ)
//=============================================================================

//=============================================================================
// 型定義(typedef, 構造体等)
//=============================================================================

//=============================================================================
// 内部関数のプロトタイプ宣言
//=============================================================================

//=============================================================================
// 内部変数・内部定数定義
//=============================================================================
unsigned long  j;
signed long adtemp;
signed long temp;
unsigned short SLOPE=Slope*100;
//=============================================================================
// 外部変数・外部定数定義
//=============================================================================

//=============================================================================
//  内部関数
//=============================================================================

//*****************************************************************************
/// 関数の説明を記述する。
/// 
/// 内部関数は以下を除き外部関数の定義と同様
/// - 一文字目を小文字にする
/// - static定義する。
//*****************************************************************************

//=============================================================================
//  外部関数
//=============================================================================

//*****************************************************************************
/// 関数の説明を記述する。
///
/// 外部関数は以下のルールに従い記述する。
/// ・1文字目を大文字で定義。また単語の区切りは大文字にする
/// ・引数の説明はそれぞれの引数の宣言の横に「///<」を書いて記述する。
/// ・戻り値の説明は以下のように記述する
///
/// @retval true	戻り値がtrue になる場合の説明 
/// @retval false	戻り値がfalse になる場合の説明
//*****************************************************************************

//*****************************************************************************
/// 温度検知リセット関数
//  マイコン温度が50℃以上になったらリセットする
//*****************************************************************************
void temp_reset( void ){
	SYSTEM.SWRR=0xA501;					//マイコンを落とす
	SYSTEM.PRCR.WORD=0xA500;
}

//*****************************************************************************
/// 温度センサ設定関数
//*****************************************************************************

void AD_init( void ){
	MSTP(S12AD)				= 0;
	MSTP(TEMPS)				= 0;
	S12AD.ADEXICR.BIT.TSS	= 1;		//温度センサ出力をA/D変換する
	S12AD.ADCSR.BIT.ADCS	= 0;		//シングルスキャンモード
	S12AD.ADSSTRT			= 100;		//アナログ入力サンプリング時間
	S12AD.ADSTRGR.BIT.TRSA	= 0x0A;		//A/D変換開始鳥が選択→温度センサからのトリガ
	S12AD.ADCSR.BIT.TRGE	= 1;		//同期、非同期トリガによるA/D変換の開始を許可
	S12AD.ADCSR.BIT.EXTRG	= 0;		//温度センサによるA/D変換の開始を選択
	TEMPS.TSCR.BIT.PGAGAIN	= 0x03;		//PGAゲイン　4.5V≦AVCC0≦5.5V
}

//*****************************************************************************
/// 温度測定関数
//*****************************************************************************

void tempa_init( void ){
	TEMPS.TSCR.BIT.TSEN		= 1;				//温度センサが動作
	for(j=0;j<500;j++);							//温度センサ起動まで(大体80μs)待つ(CMTに変更する)
	TEMPS.TSCR.BIT.PGAEN	= 1;				//PGAが動作
	while(TEMPS.TSCR.BIT.PGAEN ==1);			//A/D変換終了まで待つ
	adtemp = S12AD.ADTSDR;						//温度データのadtempに入れる
	TEMPS.TSCR.BIT.TSEN		= 0;				//温度センサ停止
	temp=(((adtemp*Vcc/AD12bit)-V1)*100/SLOPE) +T1;	//℃へ温度計算(浮動小数点演算を避けるため一度100をかけてから100で割る)
	if(temp>50){								//50℃以上になったらリセット
		temp_reset();
	}
}
